package com.digosofter.digodroid.activitys;

import java.util.ArrayList;

import android.content.Context;
import android.content.Intent;
import android.database.Cursor;
import android.graphics.Color;
import android.os.Bundle;
import android.text.Editable;
import android.text.TextWatcher;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.inputmethod.InputMethodManager;
import android.widget.AbsListView;
import android.widget.AbsListView.OnScrollListener;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.EditText;
import android.widget.ListView;
import android.widget.TextView;

import com.digosofter.digodroid.App;
import com.digosofter.digodroid.R;
import com.digosofter.digodroid.adapters.AdpCadastro;
import com.digosofter.digodroid.database.DbTabela;
import com.digosofter.digodroid.erro.Erro;
import com.digosofter.digodroid.itens.ItmCadastro;

public class ActCadastro extends ActBase {
	// CONSTANTES

	public enum EnmResultadoTipo {
		VOLTAR, REGISTRO_SELECIONADO
	}

	// FIM CONSTANTES

	// ATRIBUTOS

	private AdpCadastro _adpCadastro;

	private AdpCadastro getAdpCadastro() {
		return _adpCadastro;
	}

	private void setAdpCadastro(AdpCadastro adpCadastro) {
		_adpCadastro = adpCadastro;
	}

	private EditText _edtPesquisa;

	private EditText getEdtPesquisa() {
		// VARIÁVEIS
		// FIM VARIÁVEIS
		try {
			// AÇÕES

			if (_edtPesquisa == null) {
				_edtPesquisa = (EditText) this.findViewById(R.id.actCadastro_edtPesquisa);
			}

			// FIM AÇÕES
		} catch (Exception ex) {

			new Erro(App.getApp().getStrTextoPadrao(0), ex.getMessage());

		} finally {
		}

		return _edtPesquisa;
	}

	private ListView _objListView;

	public ListView getObjListView() {
		// VARIÁVEIS
		// FIM VARIÁVEIS
		try {
			// AÇÕES

			if (_objListView == null) {
				_objListView = (ListView) findViewById(R.id.actCadastro_pnlTbl);
				_objListView.setCacheColorHint(Color.TRANSPARENT);
			}

			// FIM AÇÕES
		} catch (Exception ex) {

			new Erro(App.getApp().getStrTextoPadrao(0), ex.getMessage());

		} finally {
		}

		return _objListView;
	}

	private DbTabela _tbl;

	public DbTabela getTbl() {
		return _tbl;
	}

	private void setTbl(DbTabela tbl) {
		// VARIÁVEIS
		// FIM VARIÁVEIS
		try {
			// AÇÕES

			_tbl = tbl;
			this.setTitle(_tbl.getStrNomeExibicao());

			if (_tbl.getStrDescricao() != null) {
				this.getTxtTblDescricao().setText(_tbl.getStrDescricao());
				this.getTxtTblDescricao().setVisibility(View.VISIBLE);
			}

			// FIM AÇÕES
		} catch (Exception ex) {

			new Erro(App.getApp().getStrTextoPadrao(0), ex.getMessage());

		} finally {
		}
	}

	private TextView _txtTblDescricao;

	private TextView getTxtTblDescricao() {
		// VARIÁVEIS
		// FIM VARIÁVEIS
		try {
			// AÇÕES

			if (_txtTblDescricao == null) {
				_txtTblDescricao = (TextView) this.findViewById(R.id.actCadastro_txtTblDescricao);
			}

			// FIM AÇÕES
		} catch (Exception ex) {

			new Erro(App.getApp().getStrTextoPadrao(0), ex.getMessage());

		} finally {
		}

		return _txtTblDescricao;
	}

	// FIM ATRIBUTOS

	// CONSTRUTORES
	// FIM CONSTRUTORES

	// MÉTODOS

	@Override
	protected void montarLayout() {
		// VARIÁVEIS

		ArrayList<ItmCadastro> lstObjItmCadastro;
		ItmCadastro itmCadastro;
		Cursor objCursor;

		// FIM VARIÁVEIS
		try {
			// AÇÕES

			lstObjItmCadastro = new ArrayList<ItmCadastro>();
			objCursor = this.getTbl().getCrsDadosTelaCadastro();

			if (objCursor != null) {
				if (objCursor.moveToFirst()) {
					do {

						itmCadastro = new ItmCadastro();
						itmCadastro.setIntItemId(objCursor.getInt(objCursor.getColumnIndex(this.getTbl()
								.getClnChavePrimaria().getStrNomeSimplificado())));

						if (this.getTbl().getClnNome().getClnReferencia() != null) {
							itmCadastro.setStrNome(objCursor.getString(objCursor.getColumnIndex("_strNomeB")));
						} else {
							itmCadastro.setStrNome(objCursor.getString(objCursor.getColumnIndex(this.getTbl()
									.getClnNome().getStrNomeSimplificado())));
						}

						for (int intColunaIndex = 0; intColunaIndex <= 4; intColunaIndex++) {
							if (intColunaIndex < objCursor.getColumnCount()) {

								switch (intColunaIndex) {
								case 2:
									itmCadastro.setStrCampo001Nome(this.getTbl().getStrClnNomePeloNomeSimplificado(
											objCursor.getColumnName(intColunaIndex)));
									itmCadastro.setStrCampo001Valor(objCursor.getString(intColunaIndex));
									break;
								case 3:
									itmCadastro.setStrCampo002Nome(this.getTbl().getStrClnNomePeloNomeSimplificado(
											objCursor.getColumnName(intColunaIndex)));
									itmCadastro.setStrCampo002Valor(objCursor.getString(intColunaIndex));
									break;
								case 4:
									itmCadastro.setStrCampo003Nome(this.getTbl().getStrClnNomePeloNomeSimplificado(
											objCursor.getColumnName(intColunaIndex)));
									itmCadastro.setStrCampo003Valor(objCursor.getString(intColunaIndex));
									break;
								}

							}
						}

						lstObjItmCadastro.add(itmCadastro);

					} while (objCursor.moveToNext());
				}
			}

			this.setAdpCadastro(new AdpCadastro(this, lstObjItmCadastro));
			this.getObjListView().setAdapter(this.getAdpCadastro());
			this.getSupportActionBar().hide();

			// FIM AÇÕES
		} catch (Exception ex) {

			new Erro(App.getApp().getStrTextoPadrao(114), ex.getMessage());

		} finally {
		}
	}

	@Override
	protected void setEventos() {
		// VARIÁVEIS
		// FIM VARIÁVEIS
		try {
			// AÇÕES

			this.getEdtPesquisa().addTextChangedListener(new TextWatcher() {

				@Override
				public void onTextChanged(CharSequence s, int start, int before, int count) {
					ActCadastro.this.getAdpCadastro().getFilter().filter(s);
				}

				@Override
				public void beforeTextChanged(CharSequence s, int start, int count, int after) {
				}

				@Override
				public void afterTextChanged(Editable s) {
				}
			});

			this.getObjListView().setOnItemClickListener(new OnItemClickListener() {
				public void onItemClick(AdapterView<?> parent, View view, int position, long id) {
					// VARIÁVEIS

					ItmCadastro objItem;
					Intent objIntentResult;

					// FIM VARIÁVEIS
					try {
						// AÇÕES

						objItem = (ItmCadastro) ActCadastro.this.getObjListView().getItemAtPosition(position);

						objIntentResult = new Intent();
						objIntentResult.putExtra("intId", objItem.getIntItemId());

						setResult(ActCadastro.EnmResultadoTipo.REGISTRO_SELECIONADO.ordinal(), objIntentResult);

						finish();

						// FIM AÇÕES
					} catch (Exception ex) {

						new Erro(App.getApp().getStrTextoPadrao(115), ex.getMessage());

					} finally {
					}
				}
			});

			this.getObjListView().setOnScrollListener(new OnScrollListener() {

				@Override
				public void onScrollStateChanged(AbsListView view, int scrollState) {
					// VARIÁVEIS

					InputMethodManager inputManager;

					// FIM VARIÁVEIS
					try {
						// AÇÕES

						inputManager = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);
						inputManager.hideSoftInputFromWindow(getCurrentFocus().getWindowToken(),
								InputMethodManager.HIDE_NOT_ALWAYS);

						// FIM AÇÕES
					} catch (Exception ex) {

						new Erro(App.getApp().getStrTextoPadrao(0), ex.getMessage());

					} finally {
					}
				}

				@Override
				public void onScroll(AbsListView view, int firstVisibleItem, int visibleItemCount, int totalItemCount) {
				}
			});

			// FIM AÇÕES
		} catch (Exception ex) {

			new Erro(App.getApp().getStrTextoPadrao(116), ex.getMessage());

		} finally {
		}
	}

	// FIM MÉTODOS

	// EVENTOS

	@Override
	protected void onCreate(Bundle savedInstanceState) {

		super.onCreate(savedInstanceState);

		// VARIÁVEIS
		// FIM VARIÁVEIS
		try {
			// AÇÕES

			this.setContentView(R.layout.act_cadastro);
			this.setTbl(App.getApp().getTblSelecionada());
			this.montarLayout();
			this.setEventos();

			// FIM AÇÕES
		} catch (Exception ex) {

			new Erro(App.getApp().getStrTextoPadrao(117), ex.getMessage());

		} finally {
		}
	}

	@Override
	public boolean onCreateOptionsMenu(Menu menu) {
		// VARIÁVEIS
		// FIM VARIÁVEIS
		try {
			// AÇÕES

			this.getMenuInflater().inflate(R.menu.act_cadastro, menu);

			// FIM AÇÕES
		} catch (Exception ex) {

			new Erro(App.getApp().getStrTextoPadrao(0), ex.getMessage());

		} finally {
		}

		return true;
	}

	@Override
	public boolean onOptionsItemSelected(MenuItem item) {
		// VARIÁVEIS
		// FIM VARIÁVEIS
		try {
			// AÇÕES

			switch (item.getItemId()) {
			case android.R.id.home:
				this.onBackPressed();
				break;
			}

			// FIM AÇÕES
		} catch (Exception ex) {

			new Erro(App.getApp().getStrTextoPadrao(0), ex.getMessage());

		} finally {
		}

		return super.onOptionsItemSelected(item);
	}

	// FIM EVENTOS

}
